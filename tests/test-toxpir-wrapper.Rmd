---
title: "Test: Mapping an index generated by toxpiR"
author: "Daniel Vogler"
date: "2024-07-09"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
root_dir <- config::get()
datasets_folder <- "/Drivers/multiyear drought risk/"

dataset_dir <- paste0(root_dir, datasets_folder)
print(file.exists(dataset_dir))

filename <- "final_results_dissemination_NDINDC.xlsx"

filepath <- paste0(dataset_dir, filename)

drought_data <- read_xlsx(filepath, sheet=1) %>% 
  mutate(FIPS = as.character(FIPS)) %>% 
  mutate(FIPS = sub("^0+", "", FIPS)) %>%
  mutate(NDC = as.numeric(NDC))
```

```{r}
source("~/Documents/DSSG/WaterReuseDSSG2024/scripts/toxpi-wrapper.R")
source("~/Documents/DSSG/WaterReuseDSSG2024/map_utils/map_utils.R")
source("~/Documents/DSSG/WaterReuseDSSG2024/map_utils/mapper.R")

df <- drought_data %>% select(c("FIPS", "NDC", "NDI"))

index <- create_index(df, "FIPS", c(1,1), "my_index")

print(index)
```

```{r}
counties <- get_urbn_map(map = "counties", sf=TRUE) %>%
  filter(!(state_abbv %in% c("HI", "AK")))

map_choropleth(data = index, 
               shapefile = counties, 
               data_key = "id", 
               shape_key = "county_fips", 
               variable = "my_index", 
               map_percentile = FALSE, 
               map_title = "Map of a ToxPi generated index!")
```

```{r}

setwd("/Users/danielvogler/Documents/DSSG/WaterReuseDSSG2024/")

mapper(data = index, shapefile = counties, variable_name = "my_index", data_key = "id", shape_key = "county_fips", plot = "choropleth", map_path = "private", map_percentile = TRUE)
```